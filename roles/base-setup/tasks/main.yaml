---
- name: Update apt cache
  apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install essential packages
  apt:
    name:
      - vim
      - git
      - curl
      - htop
      - ncdu
      - rsync
    state: present

- name: Reduce SD card wear - disable swap
  block:
    - name: Check if dphys-swapfile exists
      stat:
        path: /usr/sbin/dphys-swapfile
      register: dphys_swapfile_binary

    - name: Stop swap (old method)
      command: dphys-swapfile swapoff
      when: dphys_swapfile_binary.stat.exists
      ignore_errors: true

    - name: Uninstall swap (old method)
      command: dphys-swapfile uninstall
      when: dphys_swapfile_binary.stat.exists
      ignore_errors: true

    - name: Disable swap via systemd (modern method)
      systemd:
        name: swap.target
        masked: true
      ignore_errors: true

    - name: Turn off all swap
      command: swapoff -a
      ignore_errors: true

- name: Install log2ram for SD card longevity
  block:
    - name: Add azlux GPG key
      get_url:
        url: https://azlux.fr/repo.gpg
        dest: /usr/share/keyrings/azlux-archive-keyring.gpg
        mode: "0644"

    - name: Add azlux repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/azlux-archive-keyring.gpg] http://packages.azlux.fr/debian/ bookworm main"
        state: present
        filename: azlux

    - name: Install log2ram
      apt:
        name: log2ram
        state: present
        update_cache: true
